<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Inventory</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-boxes-stacked"></i> <span>Inventory</span></h1>
            </div>
            
            <nav class="sidebar-nav">
                <ul>
                    <li>
                        <a href="#" data-page="dashboard" class="active">
                            <i class="fas fa-home"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="warehouses">
                            <i class="fas fa-warehouse"></i>
                            <span>Warehouses</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="boxes">
                            <i class="fas fa-box"></i>
                            <span>Boxes</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="items">
                            <i class="fas fa-cube"></i>
                            <span>Items</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="packages">
                            <i class="fas fa-cubes"></i>
                            <span>Packages</span>
                        </a>
                    </li>
                    <li class="manager-only">
                        <a href="#" data-page="checks">
                            <i class="fas fa-clipboard-check"></i>
                            <span>Inventory Check</span>
                        </a>
                    </li>
                    <li class="admin-only">
                        <a href="#" data-page="users">
                            <i class="fas fa-users"></i>
                            <span>Users</span>
                        </a>
                    </li>
                    <li class="admin-only">
                        <a href="#" data-page="settings">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="user-info">
                <div class="user-name" id="userName">User</div>
                <div class="user-role" id="userRole">Role</div>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Alerts -->
            <div id="alerts"></div>

            <!-- Dashboard Page -->
            <div id="page-dashboard" class="page">
                <div class="page-header">
                    <h2>Dashboard</h2>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="icon warehouses">
                            <i class="fas fa-warehouse"></i>
                        </div>
                        <div class="info">
                            <h3 id="stat-warehouses">0</h3>
                            <p>Warehouses</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="icon boxes">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="info">
                            <h3 id="stat-boxes">0</h3>
                            <p>Boxes</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="icon items">
                            <i class="fas fa-cube"></i>
                        </div>
                        <div class="info">
                            <h3 id="stat-items">0</h3>
                            <p>Total Items</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="icon packages">
                            <i class="fas fa-cubes"></i>
                        </div>
                        <div class="info">
                            <h3 id="stat-packages">0</h3>
                            <p>Active Packages</p>
                        </div>
                    </div>
                    
                    <div class="stat-card admin-only">
                        <div class="icon users">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="info">
                            <h3 id="stat-users">0</h3>
                            <p>Users</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Warehouses Page -->
            <div id="page-warehouses" class="page hidden">
                <div class="page-header">
                    <h2>Warehouses</h2>
                    <button class="btn btn-primary admin-only" onclick="showWarehouseModal()">
                        <i class="fas fa-plus"></i> Add Warehouse
                    </button>
                </div>
                
                <div class="card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Location</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="warehousesTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Boxes Page -->
            <div id="page-boxes" class="page hidden">
                <div class="page-header">
                    <h2>Boxes</h2>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="exportBoxesCSV()">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                        <label class="btn btn-secondary manager-only">
                            <i class="fas fa-upload"></i> Import CSV
                            <input type="file" id="boxImportFile" accept=".csv" onchange="importBoxesCSV(this)" hidden>
                        </label>
                        <button class="btn btn-primary manager-only" onclick="showBoxModal()">
                            <i class="fas fa-plus"></i> Add Box
                        </button>
                    </div>
                </div>
                
                <div class="filters">
                    <select id="boxWarehouseFilter" class="warehouse-select" onchange="filterBoxes()">
                        <option value="">All Warehouses</option>
                    </select>
                </div>
                
                <div class="card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Barcode</th>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Warehouse</th>
                                    <th>Actions</th>
                                    <th>Scan</th>
                                </tr>
                            </thead>
                            <tbody id="boxesTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Items Page -->
            <div id="page-items" class="page hidden">
                <div class="page-header">
                    <h2>Items</h2>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="exportItemsCSV()">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                        <label class="btn btn-secondary manager-only">
                            <i class="fas fa-upload"></i> Import CSV
                            <input type="file" id="itemImportFile" accept=".csv" onchange="importItemsCSV(this)" hidden>
                        </label>
                        <button class="btn btn-primary manager-only" onclick="showItemModal()">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                </div>
                
                <div class="filters">
                    <select id="itemBoxFilter" class="box-select" onchange="filterItems()">
                        <option value="">All Boxes</option>
                    </select>
                    <input type="text" id="itemSearch" placeholder="Search items..." onkeyup="searchItems()">
                </div>
                
                <div class="card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Barcode</th>
                                    <th>Origin</th>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Qty</th>
                                    <th>Price</th>
                                    <th>Box</th>
                                    <th>Actions</th>
                                    <th>Scan</th>
                                </tr>
                            </thead>
                            <tbody id="itemsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Packages Page -->
            <div id="page-packages" class="page hidden">
                <div class="page-header">
                    <h2>Packages</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary manager-only" onclick="showPackageModal()">
                            <i class="fas fa-plus"></i> New Package
                        </button>
                    </div>
                </div>
                
                <div class="filters">
                    <select id="packageStatusFilter" class="status-select" onchange="filterPackages()">
                        <option value="">All Statuses</option>
                        <option value="new">New</option>
                        <option value="sourcing">Sourcing</option>
                        <option value="packed">Packed</option>
                        <option value="done">Done</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                
                <div class="card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Barcode</th>
                                    <th>Name</th>
                                    <th>Status</th>
                                    <th>Items</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                    <th>Scan</th>
                                </tr>
                            </thead>
                            <tbody id="packagesTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Inventory Checks Page -->
            <div id="page-checks" class="page hidden">
                <div class="page-header">
                    <h2>Inventory Checks</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary manager-only" onclick="showNewCheckModal()">
                            <i class="fas fa-plus"></i> New Check
                        </button>
                    </div>
                </div>
                
                <!-- Active Check Banner -->
                <div id="activeCheckBanner" class="active-check-banner hidden">
                    <div class="banner-content">
                        <i class="fas fa-clipboard-check"></i>
                        <span>Active Check: <strong id="activeCheckName"></strong></span>
                        <span class="check-progress" id="activeCheckProgress">0/0 items</span>
                    </div>
                    <div class="banner-actions">
                        <button class="btn btn-sm" onclick="viewActiveCheck()">View</button>
                        <button class="btn btn-sm btn-success" onclick="completeActiveCheck()">Complete</button>
                        <button class="btn btn-sm btn-danger" onclick="cancelActiveCheck()">Cancel</button>
                    </div>
                </div>
                
                <div class="filters">
                    <select id="checkStatusFilter" class="status-select" onchange="filterChecks()">
                        <option value="">All Statuses</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                
                <div class="card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                    <th>Differences</th>
                                    <th>Started</th>
                                    <th>Completed</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="checksTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Check Detail View -->
            <div id="page-check-detail" class="page hidden">
                <div class="page-header">
                    <h2>
                        <button class="btn btn-back" onclick="navigateTo('checks')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <span id="checkDetailTitle">Inventory Check</span>
                    </h2>
                    <div class="header-actions" id="checkDetailActions">
                        <select id="compareCheckSelect" class="compare-select" onchange="loadCheckComparison()">
                            <option value="">Compare with...</option>
                        </select>
                        <button class="btn btn-secondary" onclick="exportCheckForPrint()">
                            <i class="fas fa-print"></i> Print
                        </button>
                        <button class="btn btn-success" id="completeCheckBtn" onclick="completeCurrentCheck()">
                            <i class="fas fa-check"></i> Complete
                        </button>
                        <button class="btn btn-danger" id="cancelCheckBtn" onclick="cancelCurrentCheck()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
                
                <div class="check-summary" id="checkSummary">
                    <div class="summary-item">
                        <span class="label">Total Items:</span>
                        <span class="value" id="checkTotalItems">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Checked:</span>
                        <span class="value" id="checkCheckedItems">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Remaining:</span>
                        <span class="value" id="checkRemainingItems">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Differences:</span>
                        <span class="value" id="checkDifferences">0</span>
                    </div>
                </div>
                
                <div class="check-hint" id="checkModeHint">
                    <i class="fas fa-barcode"></i> Scan item barcodes to check them
                </div>
                
                <div id="checkBoxGroups" class="check-box-groups"></div>
            </div>

            <!-- Users Page (Admin Only) -->
            <div id="page-users" class="page hidden">
                <div class="page-header">
                    <h2>Users</h2>
                    <button class="btn btn-primary" onclick="showUserModal()">
                        <i class="fas fa-plus"></i> Add User
                    </button>
                </div>
                
                <div class="card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Full Name</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Page (Admin Only) -->
            <div id="page-settings" class="page hidden">
                <div class="page-header">
                    <h2><i class="fas fa-cog"></i> Settings</h2>
                </div>
                
                <div class="settings-container">
                    <!-- Barcode Pattern Settings -->
                    <div class="card settings-card">
                        <div class="card-header">
                            <h3><i class="fas fa-barcode"></i> Barcode Pattern</h3>
                        </div>
                        <div class="card-body">
                            <p class="settings-description">
                                Define a pattern for your internal inventory barcodes. Barcodes that don't match this pattern 
                                will be treated as external (EAN/UPC/ISBN) and trigger an automatic online lookup.
                            </p>
                            
                            <div class="pattern-syntax">
                                <h4>Pattern Syntax:</h4>
                                <ul>
                                    <li><code>#</code> - Matches a single digit (0-9)</li>
                                    <li><code>*</code> - Matches any single character</li>
                                    <li><code>$</code> - Matches any character or none (optional)</li>
                                    <li>Other characters - Must match exactly</li>
                                </ul>
                            </div>
                            
                            <div class="pattern-examples">
                                <h4>Examples:</h4>
                                <table class="examples-table">
                                    <tr>
                                        <td><code>######</code></td>
                                        <td>6-digit number (000000 - 999999)</td>
                                    </tr>
                                    <tr>
                                        <td><code>INV-####</code></td>
                                        <td>INV- followed by 4 digits (INV-0000 - INV-9999)</td>
                                    </tr>
                                    <tr>
                                        <td><code>LA######$</code></td>
                                        <td>LA + 6 digits + optional char (LA150177 or LA150177M)</td>
                                    </tr>
                                    <tr>
                                        <td><code>WH##-BOX###</code></td>
                                        <td>Warehouse/Box format (WH01-BOX001)</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div class="form-group">
                                <label for="barcodePattern">Barcode Pattern</label>
                                <input type="text" id="barcodePattern" placeholder="e.g. ######" 
                                       oninput="updatePatternPreview()">
                                <small class="form-hint">Leave empty to accept all barcodes as internal</small>
                            </div>
                            
                            <div id="patternPreview" class="pattern-preview hidden">
                                <h4>Pattern Preview:</h4>
                                <div class="preview-examples" id="patternExamples"></div>
                            </div>
                            
                            <div class="form-group pattern-test">
                                <label for="testBarcode">Test a Barcode</label>
                                <div class="input-group">
                                    <input type="text" id="testBarcode" placeholder="Enter barcode to test..." 
                                           onkeydown="if(event.key==='Enter'){event.preventDefault();testBarcodePattern();}">
                                    <button type="button" class="btn btn-secondary" onclick="testBarcodePattern()">
                                        <i class="fas fa-check"></i> Test
                                    </button>
                                </div>
                                <div id="testResult" class="test-result hidden"></div>
                            </div>
                            
                            <button type="button" class="btn btn-primary" onclick="saveBarcodePattern()">
                                <i class="fas fa-save"></i> Save Pattern
                            </button>
                        </div>
                    </div>
                    
                    <!-- Auto Lookup Settings -->
                    <div class="card settings-card">
                        <div class="card-header">
                            <h3><i class="fas fa-search"></i> External Barcode Lookup</h3>
                        </div>
                        <div class="card-body">
                            <p class="settings-description">
                                When a scanned barcode doesn't match the internal pattern, automatically search 
                                online databases (Open Food Facts, Open Library, UPC Database) for product information.
                            </p>
                            
                            <div class="form-group">
                                <label class="toggle-label">
                                    <input type="checkbox" id="autoLookupEnabled" onchange="saveAutoLookupSetting()">
                                    <span class="toggle-switch"><span class="toggle-slider"></span></span>
                                    <span>Enable automatic online lookup for external barcodes</span>
                                </label>
                            </div>
                            
                            <div class="lookup-sources">
                                <h4>Data Sources (Free):</h4>
                                <ul>
                                    <li><i class="fas fa-utensils"></i> <strong>Open Food Facts</strong> - Food & consumer products</li>
                                    <li><i class="fas fa-book"></i> <strong>Open Library</strong> - Books (ISBN)</li>
                                    <li><i class="fas fa-shopping-cart"></i> <strong>UPC Database</strong> - General products</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Supplier Patterns -->
                    <div class="card settings-card">
                        <div class="card-header">
                            <h3><i class="fas fa-store"></i> Supplier Barcode Patterns</h3>
                        </div>
                        <div class="card-body">
                            <p class="settings-description">
                                Define patterns for supplier inventory codes. When a barcode matches a supplier pattern,
                                a direct link to search on their website will be available.
                            </p>
                            
                            <div class="pattern-syntax">
                                <h4>Pattern Syntax:</h4>
                                <ul>
                                    <li><code>#</code> - Matches a single digit (0-9)</li>
                                    <li><code>*</code> - Matches any single character</li>
                                    <li><code>$</code> - Matches any character or none (optional)</li>
                                    <li>Other characters - Must match exactly (case-insensitive)</li>
                                </ul>
                                <p><strong>Example:</strong> Pattern <code>LA######$</code> matches <code>LA150177</code> or <code>LA150177M</code></p>
                            </div>
                            
                            <div class="supplier-patterns-list" id="supplierPatternsList">
                                <!-- Patterns loaded dynamically -->
                            </div>
                            
                            <button type="button" class="btn btn-primary" onclick="showSupplierPatternModal()">
                                <i class="fas fa-plus"></i> Add Supplier Pattern
                            </button>
                            
                            <div class="form-group pattern-test" style="margin-top: 20px;">
                                <label for="testSupplierBarcode">Test a Barcode Against Suppliers</label>
                                <div class="input-group">
                                    <input type="text" id="testSupplierBarcode" placeholder="e.g., LA150177M"
                                           onkeydown="if(event.key==='Enter'){event.preventDefault();testSupplierBarcode();}">
                                    <button type="button" class="btn btn-secondary" onclick="testSupplierBarcode()">
                                        <i class="fas fa-search"></i> Test
                                    </button>
                                </div>
                                <div id="supplierTestResult" class="test-result hidden"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Supplier Pattern Modal -->
    <div id="supplierPatternModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="supplierPatternModalTitle">Add Supplier Pattern</h3>
                <button class="modal-close" onclick="closeSupplierPatternModal()">&times;</button>
            </div>
            <form id="supplierPatternForm" onsubmit="saveSupplierPattern(event)">
                <input type="hidden" id="supplierPatternId">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="supplierPatternName">Supplier Name *</label>
                        <input type="text" id="supplierPatternName" required placeholder="e.g., LaskaKit">
                    </div>
                    <div class="form-group">
                        <label for="supplierPatternPattern">Barcode Pattern *</label>
                        <input type="text" id="supplierPatternPattern" required placeholder="e.g., LA######*">
                        <small class="form-hint"># = digit, * = any character</small>
                    </div>
                    <div class="form-group">
                        <label for="supplierPatternUrl">Search URL *</label>
                        <input type="text" id="supplierPatternUrl" required 
                               placeholder="e.g., https://laskakit.cz/vyhledavani/?string={barcode}">
                        <small class="form-hint">Use <code>{barcode}</code> as placeholder for the scanned code</small>
                    </div>
                    <div class="form-group">
                        <label for="supplierPatternDescription">Description</label>
                        <textarea id="supplierPatternDescription" rows="2" 
                                  placeholder="Optional description..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="toggle-label">
                            <input type="checkbox" id="supplierPatternEnabled" checked>
                            <span class="toggle-switch"><span class="toggle-slider"></span></span>
                            <span>Enabled</span>
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeSupplierPatternModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Warehouse Modal -->
    <div id="warehouseModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="warehouseModalTitle">Add Warehouse</h3>
                <button class="modal-close" onclick="closeWarehouseModal()">&times;</button>
            </div>
            <form id="warehouseForm" onsubmit="saveWarehouse(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="warehouseName">Name *</label>
                        <input type="text" id="warehouseName" required>
                    </div>
                    <div class="form-group">
                        <label for="warehouseDescription">Description</label>
                        <textarea id="warehouseDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="warehouseLocation">Location</label>
                        <input type="text" id="warehouseLocation">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeWarehouseModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Box Modal -->
    <div id="boxModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="boxModalTitle">Add Box</h3>
                <button class="modal-close" onclick="closeBoxModal()">&times;</button>
            </div>
            <form id="boxForm" onsubmit="saveBox(event)">
                <input type="hidden" id="boxId">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="boxBarcode">Barcode *</label>
                        <input type="text" id="boxBarcode" required>
                    </div>
                    <div class="form-group">
                        <label for="boxName">Name *</label>
                        <input type="text" id="boxName" required>
                    </div>
                    <div class="form-group">
                        <label for="boxDescription">Description</label>
                        <textarea id="boxDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="boxLocation">Location</label>
                        <input type="text" id="boxLocation" placeholder="e.g. Shelf A, Row 3">
                    </div>
                    <div class="form-group">
                        <label for="boxWarehouse">Warehouse *</label>
                        <select id="boxWarehouse" class="warehouse-select-required" required></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeBoxModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Move Box Modal -->
    <div id="moveBoxModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Move Box</h3>
                <button class="modal-close" onclick="closeMoveBoxModal()">&times;</button>
            </div>
            <form onsubmit="moveBox(event)">
                <div class="modal-body">
                    <input type="hidden" id="moveBoxId">
                    <p>Move box <strong id="moveBoxName"></strong> to:</p>
                    <div class="form-group">
                        <label for="moveBoxTarget">Target Warehouse *</label>
                        <select id="moveBoxTarget" class="warehouse-select-required" required></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeMoveBoxModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">Move</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Item Modal -->
    <div id="itemModal" class="modal-overlay">
        <div class="modal item-modal-expandable">
            <div class="modal-main-content">
                <div class="modal-header">
                    <h3 id="itemModalTitle">Add Item</h3>
                    <button class="modal-close" onclick="closeItemModal()">&times;</button>
                </div>
                <form id="itemForm" onsubmit="saveItem(event)">
                    <input type="hidden" id="itemId">
                    <input type="hidden" id="itemBoxId">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="itemBarcode">Barcode *</label>
                            <div class="barcode-input-group">
                                <input type="text" id="itemBarcode" required>
                                <button type="button" class="btn btn-sm btn-secondary" onclick="lookupItemBarcode()" title="Search online databases">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Product Hint Section -->
                        <div id="productHintSection" class="product-hint-section hidden">
                            <div class="product-hint-header">
                                <i class="fas fa-lightbulb"></i> Product Found Online
                                <button type="button" class="btn btn-sm btn-success" onclick="applyProductHint()">
                                    <i class="fas fa-check"></i> Apply
                                </button>
                                <button type="button" class="btn-close-hint" onclick="hideProductHint()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="product-hint-content">
                                <div class="product-hint-image" id="productHintImage"></div>
                                <div class="product-hint-details">
                                    <div class="product-hint-name" id="productHintName"></div>
                                    <div class="product-hint-brand" id="productHintBrand"></div>
                                    <div class="product-hint-desc" id="productHintDesc"></div>
                                    <div class="product-hint-source" id="productHintSource"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Supplier Link Section -->
                        <div id="supplierLinkSection" class="supplier-link-section hidden">
                            <div class="supplier-link-header">
                                <i class="fas fa-store"></i> <span id="supplierLinkName">Supplier</span>
                                <a href="#" id="supplierLinkUrl" target="_blank" class="btn btn-sm btn-info">
                                    <i class="fas fa-external-link-alt"></i> Open
                                </a>
                                <button type="button" class="btn btn-sm btn-primary" onclick="toggleSupplierPanel()">
                                    <i class="fas fa-columns"></i> Preview
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="itemBoxInput">Box * <span class="hint">(scan or select)</span></label>
                            <div class="input-with-dropdown">
                                <input type="text" id="itemBoxInput" placeholder="Scan box barcode or type to search..." required autocomplete="off">
                                <button type="button" class="dropdown-toggle" onclick="toggleBoxDropdown()">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <div id="itemBoxDropdown" class="dropdown-menu"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="itemName">Name *</label>
                            <input type="text" id="itemName" required>
                        </div>
                        <div class="form-group">
                            <label for="itemDescription">Description</label>
                            <textarea id="itemDescription" rows="3"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="itemQuantity">Quantity *</label>
                                <input type="number" id="itemQuantity" min="1" value="1" required>
                            </div>
                            <div class="form-group">
                                <label for="itemPrice">Price</label>
                                <input type="number" id="itemPrice" min="0" step="0.01" placeholder="0.00">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="itemOriginBarcode">Origin Barcode <span class="hint">(EAN/UPC/ISBN)</span></label>
                            <input type="text" id="itemOriginBarcode" placeholder="Original product barcode">
                            <small class="form-hint">Store the original manufacturer barcode for reference</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn" onclick="closeItemModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
            <!-- Supplier Preview Panel -->
            <div id="supplierPreviewPanel" class="supplier-preview-panel hidden">
                <div class="supplier-preview-header">
                    <span id="supplierPreviewTitle">Supplier Preview</span>
                    <button type="button" class="btn-close-panel" onclick="closeSupplierPanel()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="supplier-preview-content">
                    <iframe id="supplierPreviewFrame" src="about:blank" sandbox="allow-same-origin allow-scripts allow-forms"></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- Store Item Modal -->
    <div id="storeItemModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Store Items</h3>
                <button class="modal-close" onclick="closeStoreItemModal()">&times;</button>
            </div>
            <form onsubmit="storeItem(event)">
                <div class="modal-body">
                    <input type="hidden" id="storeItemId">
                    <p>Add quantity to <strong id="storeItemName"></strong>:</p>
                    <div class="form-group">
                        <label for="storeItemQuantity">Quantity to Add</label>
                        <input type="number" id="storeItemQuantity" min="1" value="1" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeStoreItemModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">Store</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Take Item Modal -->
    <div id="takeItemModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Take Items</h3>
                <button class="modal-close" onclick="closeTakeItemModal()">&times;</button>
            </div>
            <form onsubmit="takeItem(event)">
                <div class="modal-body">
                    <input type="hidden" id="takeItemId">
                    <p>Take from <strong id="takeItemName"></strong> (max: <span id="takeItemMax"></span>):</p>
                    <div class="form-group">
                        <label for="takeItemQuantity">Quantity to Take</label>
                        <input type="number" id="takeItemQuantity" min="1" value="1" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeTakeItemModal()">Cancel</button>
                    <button type="submit" class="btn btn-warning">Take</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Move Item Modal -->
    <div id="moveItemModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Move Item</h3>
                <button class="modal-close" onclick="closeMoveItemModal()">&times;</button>
            </div>
            <form onsubmit="moveItem(event)">
                <div class="modal-body">
                    <input type="hidden" id="moveItemId">
                    <p>Move <strong id="moveItemName"></strong> to:</p>
                    <div class="form-group">
                        <label for="moveItemTarget">Target Box *</label>
                        <select id="moveItemTarget" class="box-select-required" required></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeMoveItemModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">Move</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="userModalTitle">Add User</h3>
                <button class="modal-close" onclick="closeUserModal()">&times;</button>
            </div>
            <form id="userForm" onsubmit="saveUser(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="userUsername">Username *</label>
                        <input type="text" id="userUsername" required>
                    </div>
                    <div class="form-group">
                        <label for="userEmail">Email *</label>
                        <input type="email" id="userEmail" required>
                    </div>
                    <div class="form-group" id="userPasswordGroup">
                        <label for="userPassword">Password *</label>
                        <input type="password" id="userPassword">
                    </div>
                    <div class="form-group">
                        <label for="userFullName">Full Name</label>
                        <input type="text" id="userFullName">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userRole">Role *</label>
                            <select id="userRole" required>
                                <option value="viewer">Viewer</option>
                                <option value="manager">Manager</option>
                                <option value="administrator">Administrator</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="userActive">Active</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="userActive" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeUserModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="changePasswordTitle"><i class="fas fa-key"></i> Change Password</h3>
                <button class="modal-close" onclick="closeChangePasswordModal()">&times;</button>
            </div>
            <form onsubmit="changePassword(event)">
                <input type="hidden" id="changePasswordUserId">
                <div class="modal-body">
                    <div class="form-group" id="currentPasswordGroup">
                        <label for="currentPassword">Current Password *</label>
                        <input type="password" id="currentPassword">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">New Password *</label>
                        <input type="password" id="newPassword" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm New Password *</label>
                        <input type="password" id="confirmPassword" required minlength="6">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeChangePasswordModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Change Password</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Barcode Result Modal -->
    <div id="barcodeResultModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="barcodeResultTitle">Scan Result</h3>
                <button class="modal-close" onclick="closeBarcodeResultModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="barcodeResultContent"></div>
            </div>
            <div class="modal-footer" id="barcodeResultActions"></div>
        </div>
    </div>

    <!-- Unknown Barcode Prompt Modal -->
    <div id="unknownBarcodeModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-question-circle"></i> Unknown Barcode</h3>
                <button class="modal-close" onclick="closeUnknownBarcodePrompt()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="unknown-barcode-info">
                    <p>Barcode not found in system:</p>
                    <code id="unknownBarcodeValue" class="barcode-display"></code>
                </div>
                
                <!-- Supplier Link (if matched) -->
                <div id="supplierLinkContainer" class="hidden"></div>
                
                <p class="unknown-barcode-question">What would you like to create?</p>
                <div class="unknown-barcode-buttons">
                    <button type="button" class="btn btn-lg btn-primary" onclick="createNewBox()">
                        <i class="fas fa-box"></i> Box
                    </button>
                    <button type="button" class="btn btn-lg btn-success" onclick="createNewItem()">
                        <i class="fas fa-cube"></i> Item
                    </button>
                    <button type="button" class="btn btn-lg btn-warning" onclick="createNewPackage()">
                        <i class="fas fa-cubes"></i> Package
                    </button>
                </div>
                <p class="unknown-barcode-hint">
                    <i class="fas fa-barcode"></i> Or scan <code>TYPE:BOX</code>, <code>TYPE:ITEM</code>, or <code>TYPE:PACKAGE</code>
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeUnknownBarcodePrompt()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Package Modal -->
    <div id="packageModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="packageModalTitle">New Package</h3>
                <button class="modal-close" onclick="closePackageModal()">&times;</button>
            </div>
            <form id="packageForm" onsubmit="savePackage(event)">
                <div class="modal-body">
                    <input type="hidden" id="packageId">
                    <div class="form-group">
                        <label for="packageBarcode">Barcode *</label>
                        <input type="text" id="packageBarcode" required>
                    </div>
                    <div class="form-group">
                        <label for="packageName">Name *</label>
                        <input type="text" id="packageName" required>
                    </div>
                    <div class="form-group">
                        <label for="packageDescription">Description</label>
                        <textarea id="packageDescription" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closePackageModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Package</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Package Detail Modal -->
    <div id="packageDetailModal" class="modal-overlay">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 id="packageDetailTitle">Package Details</h3>
                <button class="modal-close" onclick="closePackageDetailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="package-detail-header">
                    <div class="package-info">
                        <div class="package-barcode-display">
                            <svg id="packageDetailBarcodeSvg"></svg>
                            <code id="packageDetailBarcode"></code>
                        </div>
                        <div class="package-meta">
                            <p><strong>Name:</strong> <span id="packageDetailName"></span></p>
                            <p><strong>Description:</strong> <span id="packageDetailDescription">-</span></p>
                            <p><strong>Status:</strong> <span id="packageDetailStatus" class="status-badge"></span></p>
                            <p><strong>Created:</strong> <span id="packageDetailCreated"></span></p>
                        </div>
                    </div>
                </div>
                
                <div class="package-items-section">
                    <h4><i class="fas fa-cube"></i> Package Items</h4>
                    <div id="packageItemsEmpty" class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>No items in this package yet</p>
                        <p class="hint">Scan package barcode, then <code>OP:ADD</code>, then item barcode</p>
                    </div>
                    <table id="packageItemsTable" class="hidden">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Barcode</th>
                                <th>Source Box</th>
                                <th>Qty</th>
                                <th>Price</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="packageItemsTableBody"></tbody>
                    </table>
                </div>
                
                <div id="returnItemsSection" class="return-items-section hidden">
                    <h4><i class="fas fa-undo"></i> Return Items to Inventory</h4>
                    <p class="return-hint">Return items to their original boxes:</p>
                    <div id="returnItemsList"></div>
                    <div class="return-actions">
                        <button type="button" class="btn btn-success" onclick="returnAllItems()">
                            <i class="fas fa-undo"></i> Return All Items
                        </button>
                        <button type="button" class="btn btn-primary" onclick="markReturnsDone()">
                            <i class="fas fa-check"></i> Done
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="packageDetailFooter">
                <button type="button" class="btn" onclick="closePackageDetailModal()">Close</button>
                <button type="button" class="btn btn-warning" id="btnCancelPackage" onclick="cancelCurrentPackage()">
                    <i class="fas fa-ban"></i> Cancel Package
                </button>
                <button type="button" class="btn btn-success" id="btnPackPackage" onclick="packCurrentPackage()">
                    <i class="fas fa-box"></i> Pack
                </button>
                <button type="button" class="btn btn-primary" id="btnCompletePackage" onclick="completeCurrentPackage()">
                    <i class="fas fa-check"></i> Complete
                </button>
            </div>
        </div>
    </div>

    <!-- Quantity Prompt Modal -->
    <div id="quantityPromptModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="quantityPromptTitle">Enter Quantity</h3>
                <button class="modal-close" onclick="closeQuantityPrompt(); cancelPendingAction();">&times;</button>
            </div>
            <div class="modal-body">
                <div class="quantity-prompt-item">
                    <i class="fas fa-cube"></i> <span id="quantityPromptItem"></span>
                </div>
                <div class="quantity-input-large">
                    <button type="button" onclick="decrementQuantity()">
                        <i class="fas fa-minus"></i>
                    </button>
                    <input type="number" id="scannerQuantityInput" min="1" value="1">
                    <button type="button" onclick="incrementQuantity()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div id="quantityMaxInfo" class="quantity-max-info hidden"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeQuantityPrompt(); cancelPendingAction();">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitQuantityPrompt()">
                    <i class="fas fa-check"></i> Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- New Check Modal -->
    <div id="newCheckModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>New Inventory Check</h3>
                <button class="modal-close" onclick="closeNewCheckModal()">&times;</button>
            </div>
            <form id="newCheckForm" onsubmit="createNewCheck(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="checkName">Check Name *</label>
                        <input type="text" id="checkName" required placeholder="e.g. Monthly Check December 2025">
                    </div>
                    <div class="form-group">
                        <label for="checkDescription">Description</label>
                        <textarea id="checkDescription" rows="3" placeholder="Optional notes about this check"></textarea>
                    </div>
                    <div class="check-info-box">
                        <i class="fas fa-info-circle"></i>
                        <span>This will create a snapshot of all current items for checking.</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeNewCheckModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-clipboard-check"></i> Start Check
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Check Item Quantity Modal -->
    <div id="checkQuantityModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-clipboard-check"></i> Count Item</h3>
                <button class="modal-close" onclick="closeCheckQuantityModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="check-item-info">
                    <div class="check-item-name" id="checkItemName"></div>
                    <div class="check-item-barcode" id="checkItemBarcode"></div>
                    <div class="check-item-box" id="checkItemBox"></div>
                </div>
                <div class="check-expected">
                    Expected: <strong id="checkExpectedQty">0</strong>
                </div>
                <div class="form-group">
                    <label for="checkActualQty">Actual Count *</label>
                    <div class="quantity-input-large">
                        <button type="button" onclick="decrementCheckQuantity()">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" id="checkActualQty" min="0" value="">
                        <button type="button" onclick="incrementCheckQuantity()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeCheckQuantityModal()">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitCheckQuantity()">
                    <i class="fas fa-check"></i> Save Count
                </button>
            </div>
        </div>
    </div>

    <!-- Rolling Hints -->
    <div class="hints-widget">
        <div class="hints-container">
            <div class="hint active"><i class="fas fa-barcode"></i> Scan barcode anytime to search</div>
            <div class="hint"><i class="fas fa-arrows-alt"></i> Item  <code>OP:MOVE</code>  Box</div>
            <div class="hint"><i class="fas fa-plus-circle"></i> Item  <code>OP:ADD</code>  Qty to add</div>
            <div class="hint"><i class="fas fa-minus-circle"></i> Item  <code>OP:TAKE</code>  Qty to take</div>
            <div class="hint"><i class="fas fa-cubes"></i> Package  <code>OP:ADD</code>  Item  Qty</div>
            <div class="hint"><i class="fas fa-check-circle"></i> <code>ACT:OK</code> to pack package</div>
            <div class="hint"><i class="fas fa-times-circle"></i> <code>ACT:CANCEL</code> or ESC to cancel</div>
            <div class="hint"><i class="fas fa-question-circle"></i> Unknown?  <code>TYPE:BOX</code> / <code>TYPE:ITEM</code> / <code>TYPE:PACKAGE</code></div>
        </div>
        <a href="/static/action-codes.html" target="_blank" class="print-codes-link" title="Print action code barcodes">
            <i class="fas fa-print"></i>
        </a>
    </div>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/code-chains.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html>
